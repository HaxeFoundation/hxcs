# hxcs

[![TravisCI Build Status](https://travis-ci.org/HaxeFoundation/hxcs.svg?branch=master)](https://travis-ci.org/HaxeFoundation/hxcs)

Support library for [Haxe](https://github.com/HaxeFoundation/haxe) C# backend.

It contains a build tool that is called by Haxe, discovering and calling the C# compiler on the C# code generated by Haxe. It also contains .NET 2.0, 4.0, 4.5 and 5.0 core assemblies that contain core .NET types and APIs.

## TODO
 * C# CFFI compatibility: be able to use unmodified .ndlls (though recompilation is needed) from hxcpp and neko in C#

## Dotnet Core Support

The build tool now supports using dotnet CLI to compile the generated C# project,
when the `dotnet` tool is found (and there is an available dotnet sdk).

In order to keep compatibility with previous hxcs versions, the `dotnet` CLI is not used by default, if msvc (on Windows) or Mono compilers are found.

So, to use `dotnet` CLI, set flag: `-D dotnet_core`.

The greatest available dotnet sdk will be used to build the project, by default.
But, a preferred sdk can be selected with the `dotnet_core` option:

`-D dotnet_core=6.0` or `-D dotnet_core=7`, etc.

### Output extensions

The "classic" toolchain (msvc or mono) will use `exe` extension for executables and `dll` for libraries.

While dotnet cli may choose other extensions according to the operating system (in Linux for example, executables does not have an extension).

To change the output extension, the `outputExtension` flag can be used.
For example: `-D outputExtension=exe` can be used to rename the output extension to `exe`.

## For Contributors

### Clone Project

Since the hxcs depends on the [build-tool-base] repository (used as a submodule),
cloning the project should include submodules:

`git clone --recurse-submodules [repository-url]`


### Code Structure

* `build-tool`: contains the code which builds the C# projects generated by Haxe;
    * `base`: code which handles the CLI and calls the csharp compiler (submodule linked to the [build-tool-base] repository);
    * `src`: code for the csharp compiler itself. Base package is `compiler.cs`;

[build-tool-base]: https://github.com/waneck/build-tool-base

### Code Architecture

The `CSharpCompiler` is the facade which call the compilation process.
This process can be divided into the following steps:

* `preprocess`: parse the `input.Data` into `CompilerParameters`
* `compiler selection`: select one of the availables `CsCompiler`s based on specified parameters;
* `compilation`: uses the selected compiler to compile the project.

While the `CsCompiler` interface may be implemented in different ways,
a `CompilerPipeline` implementation is provided which further splits the compilation
process based on the following interfaces:

* `CompilerFinder`: try to find the compiler tool. That is, verify if it's available;
* `EnvironmentConfigurator`: an optional step which may modify the compilation parameters used on next steps;
* `ProjectWriter`: based on the compiler parameters, write a project file (`.csproj`), used on the compilation;
* `ArgumentsGenerator`: generate the arguments used by the compiler tool;
* `CsBuilder`: executes the compiler tool, using the generated arguments;

Two main implementations are provided for these classes:

* **Classic** (`compiler.cs.implementation.classic`): executes the _"classic"_ compilers, i.e., _Mono_ or _Msvc_ compiler tools;
* **Dotnet** (`compiler.cs.implementation.dotnet`): uses the _dotnet_ CLI tool to build the project.

Some classes (in `compiler.cs.implementation.common`) are shared between these implementations, like the `ParametersParser`, `CsProjectGenerator` and `DefaultCsBuilder`.

### Compile build tool and run tests

To compile the build tool, you can call (from root of project directory):
    `haxe build-tool.hxml`

This works as a shortcut to the `build-cs.hxml` script, which needs to be called inside the `build-tool` directory.

Similarly, the tests can be called using the shortcut scripts at the project directory:

`haxe unit-tests.hxml` and `haxe system-test.hxml`

or from the tests directories (`build-tool/tests/unit` and `build-tool/tests/system-test`)
using the munit tool:

`haxelib run munit test -neko`

#### Test dependencies

Before building the tests, it's necessary to install the test dependencies, which can be made through [haxelib].

The tests are based on [munit] and [hamcrest].
Besides that, the [proxsys] library is also used
as fake implementation to the `compiler.cs.system` layer of the build tool,
allowing to fake and verify system behaviors.

The build-tool itself depends only of the haxe standard library.

[munit]: https://lib.haxe.org/p/munit
[hamcrest]: https://lib.haxe.org/p/hamcrest
[proxsys]: https://lib.haxe.org/p/proxsys